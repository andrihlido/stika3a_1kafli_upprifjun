import React, { useState, useEffect } from 'react';
import { Play, ArrowRight, CheckCircle, XCircle, Calculator, Percent, Divide, Layers, Shuffle, Trophy, RefreshCcw, Scale, Utensils, Car, Droplets, Circle } from 'lucide-react';

/**
 * GAGNAT√ìLIN - STIKA 3A - KAFLI 3: Margf√∂ldun, deiling og hlutf√∂ll
 * Uppf√¶rt me√∞ n√Ωjum d√¶mum skv. bei√∞ni.
 */
const questionsData = [
  // --- N√ù D√ÜMI: SILJA OG SAFINN (HLUTF√ñLL) ---
  {
    id: 101,
    topic: "Hlutf√∂ll (Safi)",
    type: "input",
    question: "Silja blandar saman safa og vatni √≠ hlutfallinu 1 : 6. Hve miki√∞ vatn √æarf h√∫n √° m√≥ti 3 dl af safa?",
    acceptedAnswers: ["18", "18 dl"],
    explanation: "Hlutfalli√∞ er 1 √° m√≥ti 6. √ûa√∞ √æ√Ω√∞ir a√∞ fyrir hvern dl af safa √æarf 6 dl af vatni. \n3 ¬∑ 6 = 18 dl.",
    icon: <Droplets className="w-6 h-6 text-blue-500" />
  },
  {
    id: 102,
    topic: "Hlutf√∂ll (Safi)",
    type: "input",
    question: "Hlutfalli√∞ er 1 : 6. Hve miki√∞ vatn √æarf Silja √° m√≥ti 1,5 dl af safa?",
    acceptedAnswers: ["9", "9 dl"],
    explanation: "Reiknum: 1,5 ¬∑ 6. \n1 ¬∑ 6 = 6 og 0,5 ¬∑ 6 = 3. \n6 + 3 = 9 dl.",
    icon: <Droplets className="w-6 h-6 text-blue-500" />
  },

  // --- N√ùTT D√ÜMI: MYNDR√ÜN FRAMSETNING (BOLTAR) ---
  {
    id: 103,
    topic: "Hlutf√∂ll (Myndr√¶nt)",
    type: "visual-ratio",
    question: "Finndu hlutfalli√∞ milli gr√¶nna og fj√≥lubl√°rra boltana.",
    // Data to draw the visual
    visualData: { green: 4, purple: 12 }, 
    options: ["1 : 4", "1 : 3", "1 : 2", "4 : 16"],
    correctIndex: 1,
    explanation: "√ûa√∞ eru 4 gr√¶nir og 12 fj√≥lubl√°ir. \nHlutfalli√∞ er 4 : 12. \nVi√∞ getum stytt √æa√∞ me√∞ 4 (deilt me√∞ 4 b√°√∞um megin): 1 : 3.",
    icon: <Circle className="w-6 h-6 text-purple-500" />
  },

  // --- N√ùTT D√ÜMI: HRA√êI OG VEGALENGD ---
  {
    id: 104,
    topic: "Hlutfallareikningur",
    type: "input",
    question: "B√≠l er eki√∞ 225 km vegalengd √° 3 klukkut√≠mum. Hve langt fer b√≠llinn √° 5 klukkustundum me√∞ sama hra√∞a?",
    acceptedAnswers: ["375", "375 km"],
    explanation: "Fyrst finnum vi√∞ hva√∞ hann fer langt √° 1 t√≠ma: 225 : 3 = 75 km/klst. \nSvo margf√∂ldum vi√∞ me√∞ 5 t√≠mum: 75 ¬∑ 5 = 375 km.",
    icon: <Car className="w-6 h-6 text-red-500" />
  },

  // --- N√ù D√ÜMI: FJ√ñLDI M√ñGULEIKA (COMBINATORICS) ---
  {
    id: 105,
    topic: "Fj√∂ldi m√∂guleika",
    type: "multiple-choice",
    question: "√ç sjoppunni eru 3 tegundir af pylsum og 2 tegundir af brau√∞i. Hve margir eru m√∂guleikarnir √° a√∞ velja s√©r pylsu?",
    options: ["5 m√∂guleikar", "6 m√∂guleikar", "9 m√∂guleikar", "1 m√∂guleiki"],
    correctIndex: 1,
    explanation: "√û√∫ margfaldar saman fj√∂lda valm√∂guleika: 3 (pylsur) ¬∑ 2 (brau√∞) = 6 mismunandi samsetningar.",
    icon: <Utensils className="w-6 h-6 text-orange-500" />
  },
  {
    id: 106,
    topic: "Fj√∂ldi m√∂guleika",
    type: "input",
    question: "√Å veitingah√∫si eru 4 forr√©ttir, 5 a√∞alr√©ttir og 2 eftirr√©ttir. Hve margar mismunandi m√°lt√≠√∞ir (samsetningar) er h√¶gt a√∞ velja?",
    acceptedAnswers: ["40"],
    explanation: "Vi√∞ margf√∂ldum allt saman: 4 ¬∑ 5 ¬∑ 2. \n4 ¬∑ 5 = 20. \n20 ¬∑ 2 = 40 m√∂guleikar.",
    icon: <Utensils className="w-6 h-6 text-orange-500" />
  },

  // --- N√ùTT D√ÜMI: FRUMT√ñLUR ---
  {
    id: 107,
    topic: "Frumt√∂lur",
    type: "multiple-choice",
    question: "Hverjar af eftirfarandi t√∂lum eru frumt√∂lur? (24, 45, 61, 101)",
    options: ["24 og 45", "61 og 101", "A√∞eins 101", "45 og 61"],
    correctIndex: 1,
    explanation: "Frumt√∂lur eru t√∂lur sem a√∞eins er h√¶gt a√∞ deila me√∞ 1 og sj√°lfri s√©r. \n24 er h√¶gt a√∞ deila me√∞ 2, 3, 4, 6... (ekki frumtala). \n45 er h√¶gt a√∞ deila me√∞ 5 og 9 (ekki frumtala). \n61 og 101 eru frumt√∂lur.",
    icon: <Layers className="w-6 h-6 text-emerald-600" />
  },

  // --- ELDRI D√ÜMI (FYRIR FJ√ñLBREYTNI) ---
  {
    id: 1,
    topic: "Margf√∂ldun tugabrota",
    type: "input",
    question: "Reikna√∞u d√¶mi√∞: 0,5 ¬∑ 0,4",
    acceptedAnswers: ["0,2", "0,20"], 
    explanation: "Margfalda√∞u t√∂lurnar √°n kommu: 5 ¬∑ 4 = 20. \nTeldu svo aukastafina (samtals 2). \nSvari√∞ er 0,20 sem er n√°kv√¶mlega √æa√∞ sama og 0,2.",
    icon: <Calculator className="w-6 h-6 text-emerald-600" />
  },
  {
    id: 108,
    topic: "Margf√∂ldun",
    type: "input",
    question: "Reikna√∞u: 17 ¬∑ 35",
    acceptedAnswers: ["595"],
    explanation: "√ûa√∞ er gott a√∞ skipta d√¶minu upp: \n10 ¬∑ 35 = 350 \n7 ¬∑ 35 = 245 \nLagt saman: 350 + 245 = 595.",
    icon: <Calculator className="w-6 h-6 text-blue-500" />
  },
  {
    id: 109,
    topic: "Margf√∂ldun tugabrota",
    type: "input",
    question: "Reikna√∞u: 6 ¬∑ 3,4",
    acceptedAnswers: ["20,4", "20.4"],
    explanation: "Gott a√∞ hugsa √æetta √≠ tvennu lagi:\n6 ¬∑ 3 = 18\n6 ¬∑ 0,4 = 2,4\nLagt saman: 18 + 2,4 = 20,4.",
    icon: <Calculator className="w-6 h-6 text-emerald-600" />
  },
  {
    id: 8,
    topic: "Forgangsr√∂√∞",
    type: "multiple-choice",
    question: "Reikna√∞u: 4 + 4 ¬∑ 4 - 4",
    options: ["28", "16", "12", "0"],
    correctIndex: 1,
    explanation: "Mundu regluna: Margf√∂ldun fyrst! \n1. 4 ¬∑ 4 = 16. \n2. D√¶mi√∞ er n√∫: 4 + 16 - 4. \n3. 20 - 4 = 16.",
    icon: <Calculator className="w-6 h-6 text-red-500" />
  }
];

export default function Kafli3Updated() {
  const [gameState, setGameState] = useState('start'); 
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [inputAnswer, setInputAnswer] = useState('');
  const [selectedOption, setSelectedOption] = useState(null);
  const [showFeedback, setShowFeedback] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [randomizedQuestions, setRandomizedQuestions] = useState([]);

  useEffect(() => {
    const shuffled = [...questionsData].sort(() => 0.5 - Math.random());
    setRandomizedQuestions(shuffled);
  }, []);

  const startGame = () => {
    const shuffled = [...questionsData].sort(() => 0.5 - Math.random());
    setRandomizedQuestions(shuffled);
    setGameState('playing');
    setCurrentQuestionIndex(0);
    setScore(0);
    resetQuestionState();
  };

  const resetQuestionState = () => {
    setInputAnswer('');
    setSelectedOption(null);
    setShowFeedback(false);
    setIsCorrect(false);
  };

  const checkInputAnswer = (userAns, correctAnswers) => {
    if (!userAns) return false;
    // Normalize: remove spaces and text units, treat comma and dot equivalently
    const normalize = (str) => str.toLowerCase().replace(/km|dl|kr|\s/g, '').replace(/,/g, '.');
    const userNorm = normalize(userAns);
    
    return correctAnswers.some(ans => {
        const correctNorm = normalize(ans);
        return userNorm === correctNorm;
    });
  };

  const submitAnswer = () => {
    const currentQ = randomizedQuestions[currentQuestionIndex];
    let correct = false;

    if (currentQ.type === 'input') {
      correct = checkInputAnswer(inputAnswer, currentQ.acceptedAnswers);
    } else {
      correct = selectedOption === currentQ.correctIndex;
    }

    setIsCorrect(correct);
    if (correct) setScore(s => s + 1);
    setShowFeedback(true);
  };

  const nextQuestion = () => {
    if (currentQuestionIndex < randomizedQuestions.length - 1) {
      setCurrentQuestionIndex(prev => prev + 1);
      resetQuestionState();
    } else {
      setGameState('finished');
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !showFeedback && inputAnswer) {
      submitAnswer();
    } else if (e.key === 'Enter' && showFeedback) {
      if (currentQuestionIndex < randomizedQuestions.length - 1) nextQuestion();
    }
  };

  if (randomizedQuestions.length === 0 && gameState !== 'start') return <div>Hle√∞...</div>;

  const currentQ = randomizedQuestions[currentQuestionIndex];

  return (
    <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 font-sans text-slate-800 flex items-center justify-center p-4">
      <div className="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden border border-emerald-100">
        
        {/* PROGRESS BAR */}
        {gameState === 'playing' && (
          <div className="bg-slate-100 h-2 w-full">
            <div 
              className="bg-emerald-500 h-full transition-all duration-500 ease-out"
              style={{ width: `${((currentQuestionIndex) / randomizedQuestions.length) * 100}%` }}
            />
          </div>
        )}

        {/* HEADER */}
        {gameState === 'playing' && (
          <div className="px-6 py-4 flex justify-between items-center border-b border-slate-100 bg-white">
            <div className="text-sm font-bold text-slate-400 uppercase tracking-wider">
              D√¶mi {currentQuestionIndex + 1} / {randomizedQuestions.length}
            </div>
            <div className="flex items-center space-x-2 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
              <Trophy className="w-4 h-4 text-emerald-600" />
              <span className="font-bold text-emerald-700">{score} stig</span>
            </div>
          </div>
        )}

        {/* --- START SCREEN --- */}
        {gameState === 'start' && (
          <div className="p-12 text-center flex flex-col items-center animate-fadeIn">
            <div className="w-28 h-28 bg-emerald-500 rounded-3xl rotate-6 flex items-center justify-center mb-8 shadow-emerald-200 shadow-xl transform transition hover:rotate-12">
              <Divide className="w-14 h-14 text-white" />
            </div>
            <h1 className="text-4xl font-extrabold text-slate-800 mb-4 tracking-tight">Kafli 3</h1>
            <h2 className="text-2xl font-semibold text-emerald-600 mb-6">Margf√∂ldun og Deiling</h2>
            <p className="text-lg text-slate-500 mb-10 max-w-md leading-relaxed">
              √Üf√∞u √æig √≠ hlutfallareikningi, m√∂guleikum, frumt√∂lum og forgangsr√∂√∞un.
            </p>
            <button 
              onClick={startGame}
              className="group bg-emerald-600 hover:bg-emerald-700 text-white text-lg font-bold py-4 px-10 rounded-2xl shadow-xl transition-all transform hover:-translate-y-1 active:scale-95 flex items-center"
            >
              <Play className="w-6 h-6 mr-3 group-hover:scale-110 transition-transform" />
              Byrja Leik
            </button>
          </div>
        )}

        {/* --- GAME SCREEN --- */}
        {gameState === 'playing' && (
          <div className="p-6 md:p-10">
            
            {/* Topic Label */}
            <div className="flex justify-center mb-6">
              <div className="inline-flex items-center space-x-2 bg-slate-100 px-4 py-1.5 rounded-full text-sm font-semibold text-slate-600 shadow-sm">
                {currentQ.icon}
                <span>{currentQ.topic}</span>
              </div>
            </div>

            {/* Question Text */}
            <h2 className="text-2xl font-bold text-center text-slate-800 mb-8 leading-snug">
              {currentQ.question}
            </h2>

            {/* --- VISUAL COMPONENT FOR RATIO (BALLS) --- */}
            {currentQ.type === 'visual-ratio' && (
              <div className="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-200">
                <div className="flex flex-wrap justify-center gap-4 mb-4">
                  {/* Draw Green Balls */}
                  {Array.from({ length: currentQ.visualData.green }).map((_, i) => (
                    <div key={`g-${i}`} className="w-10 h-10 rounded-full bg-green-500 shadow-sm border-2 border-green-600 flex items-center justify-center text-white font-bold text-xs">
                      G
                    </div>
                  ))}
                </div>
                <div className="w-full h-0.5 bg-slate-200 my-4"></div>
                <div className="flex flex-wrap justify-center gap-4">
                  {/* Draw Purple Balls */}
                  {Array.from({ length: currentQ.visualData.purple }).map((_, i) => (
                    <div key={`p-${i}`} className="w-10 h-10 rounded-full bg-purple-500 shadow-sm border-2 border-purple-600 flex items-center justify-center text-white font-bold text-xs">
                      F
                    </div>
                  ))}
                </div>
                <p className="text-center text-sm text-slate-500 mt-4">Teldu k√∫lurnar til a√∞ finna hlutfalli√∞.</p>
              </div>
            )}

            {/* INPUT AREA: Text Input Type */}
            {currentQ.type === 'input' && (
              <div className="mb-10 flex justify-center">
                <input
                  type="text"
                  value={inputAnswer}
                  onChange={(e) => setInputAnswer(e.target.value)}
                  onKeyDown={handleKeyDown}
                  disabled={showFeedback}
                  placeholder="Skrifa√∞u svar..."
                  className={`
                    w-full max-w-xs text-center text-2xl p-4 rounded-xl border-2 outline-none transition-all shadow-inner
                    ${showFeedback 
                      ? (isCorrect ? 'border-green-500 bg-green-50 text-green-800' : 'border-red-500 bg-red-50 text-red-800')
                      : 'border-slate-300 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100'}
                  `}
                  autoFocus
                />
              </div>
            )}

            {/* INPUT AREA: Multiple Choice (Used for standard & visual-ratio) */}
            {(currentQ.type === 'multiple-choice' || currentQ.type === 'visual-ratio') && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10">
                {currentQ.options.map((option, idx) => {
                  let styleClass = "border-slate-200 hover:border-emerald-400 hover:bg-slate-50 text-slate-700"; 
                  
                  if (selectedOption === idx) {
                    styleClass = "border-emerald-500 bg-emerald-50 text-emerald-900 ring-2 ring-emerald-200";
                  }

                  if (showFeedback) {
                    if (idx === currentQ.correctIndex) {
                      styleClass = "border-green-500 bg-green-100 text-green-900 ring-2 ring-green-200 font-bold";
                    } else if (selectedOption === idx) {
                      styleClass = "border-red-500 bg-red-100 text-red-900 opacity-70";
                    } else {
                      styleClass = "border-slate-100 text-slate-400 opacity-50";
                    }
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => !showFeedback && setSelectedOption(idx)}
                      disabled={showFeedback}
                      className={`
                        relative p-5 rounded-2xl text-lg font-medium border-2 transition-all duration-200 text-left
                        ${styleClass}
                      `}
                    >
                      <div className="flex items-center justify-between">
                        <span>{option}</span>
                        {showFeedback && idx === currentQ.correctIndex && <CheckCircle className="text-green-600 w-6 h-6" />}
                        {showFeedback && selectedOption === idx && idx !== currentQ.correctIndex && <XCircle className="text-red-500 w-6 h-6" />}
                      </div>
                    </button>
                  );
                })}
              </div>
            )}

            {/* Action Bar */}
            <div className="flex justify-center md:justify-end">
              {!showFeedback ? (
                <button
                  onClick={submitAnswer}
                  disabled={currentQ.type !== 'input' ? selectedOption === null : !inputAnswer}
                  className={`
                    w-full md:w-auto py-4 px-10 rounded-xl font-bold text-white text-lg transition-all shadow-lg
                    ${(currentQ.type !== 'input' ? selectedOption !== null : inputAnswer)
                      ? 'bg-emerald-600 hover:bg-emerald-700 hover:-translate-y-1' 
                      : 'bg-slate-300 cursor-not-allowed shadow-none'}
                  `}
                >
                  Svara
                </button>
              ) : (
                <button
                  onClick={nextQuestion}
                  autoFocus
                  className="w-full md:w-auto bg-slate-800 hover:bg-slate-900 text-white py-4 px-10 rounded-xl font-bold shadow-lg flex items-center justify-center transition-all hover:-translate-y-1"
                >
                  {currentQuestionIndex < randomizedQuestions.length - 1 ? "N√¶sta spurning" : "Sj√° ni√∞urst√∂√∞ur"} 
                  <ArrowRight className="ml-3 w-5 h-5" />
                </button>
              )}
            </div>
            
            {/* Feedback Section */}
            {showFeedback && (
              <div className={`mt-8 p-6 rounded-2xl animate-slideUp ${isCorrect ? 'bg-green-50' : 'bg-red-50'}`}>
                <div className="flex items-start space-x-4">
                  <div className={`mt-1 p-2 rounded-full ${isCorrect ? 'bg-green-200' : 'bg-red-200'}`}>
                    {isCorrect ? <CheckCircle className="w-6 h-6 text-green-700" /> : <XCircle className="w-6 h-6 text-red-700" />}
                  </div>
                  <div>
                    <h3 className={`font-bold text-lg mb-2 ${isCorrect ? 'text-green-800' : 'text-red-800'}`}>
                      {isCorrect ? 'R√©tt!' : '√ûv√≠ mi√∞ur...'}
                    </h3>
                    <p className="text-slate-700 leading-relaxed text-lg whitespace-pre-line">
                      {currentQ.explanation}
                    </p>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* --- FINISHED SCREEN --- */}
        {gameState === 'finished' && (
          <div className="p-12 text-center flex flex-col items-center animate-fadeIn">
            <div className="w-32 h-32 bg-yellow-100 rounded-full flex items-center justify-center mb-8 ring-8 ring-yellow-50">
              <Trophy className="w-16 h-16 text-yellow-600" />
            </div>
            <h2 className="text-4xl font-bold text-slate-800 mb-2">√Üfingu Loki√∞!</h2>
            <p className="text-slate-500 mb-10 text-lg">H√©r eru ni√∞urst√∂√∞ur √∫r Kafla 3.</p>
            
            <div className="bg-slate-50 p-8 rounded-3xl border border-slate-200 mb-10 w-full max-w-sm">
              <div className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">√û√≠n Stig</div>
              <div className="text-6xl font-black text-emerald-600 mb-4">{score} <span className="text-2xl text-slate-400 font-medium">/ {randomizedQuestions.length}</span></div>
              
              <div className="h-4 w-full bg-slate-200 rounded-full overflow-hidden mb-4">
                <div 
                  className={`h-full ${score === randomizedQuestions.length ? 'bg-green-500' : 'bg-emerald-500'}`} 
                  style={{ width: `${(score / randomizedQuestions.length) * 100}%` }}
                ></div>
              </div>

              <p className="text-slate-700 font-medium">
                {score === randomizedQuestions.length 
                  ? "Fram√∫rskarandi! √û√∫ ert komin(n) me√∞ √æetta. üåü" 
                  : "Vel gert! Haltu √°fram a√∞ √¶fa deilingu og margf√∂ldun."}
              </p>
            </div>

            <button 
              onClick={startGame}
              className="bg-white border-2 border-slate-200 hover:border-emerald-500 hover:text-emerald-600 text-slate-600 font-bold py-4 px-10 rounded-2xl transition-all flex items-center shadow-sm hover:shadow-md"
            >
              <RefreshCcw className="w-5 h-5 mr-3" />
              Taka n√Ωjan leik
            </button>
          </div>
        )}
      </div>
      
      <div className="fixed bottom-4 text-slate-400 text-xs font-medium tracking-wide pointer-events-none opacity-60">
        Stika 3a ‚Ä¢ Kafli 3: Margf√∂ldun og deiling
      </div>
    </div>
  );
}